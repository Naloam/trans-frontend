{"version":3,"file":"contentScript.js","sources":["../../../src/content/contentScript.tsx"],"sourcesContent":["/**\r\n * Content Script - 注入到页面的脚本\r\n * \r\n * 功能：\r\n * - 监听文本选择和双击事件\r\n * - 创建独立的 Shadow DOM 容器避免样式冲突\r\n * - 显示翻译气泡和沉浸式覆盖层\r\n * - 与 Service Worker 通信获取翻译结果\r\n * \r\n * 样式隔离：使用 Shadow DOM 确保扩展样式不影响宿主页面\r\n * 通信约束：所有网络请求通过 Service Worker 处理，Content Script 不直接访问外部API\r\n */\r\n\r\n// 扩展Window接口以避免TypeScript错误\r\ninterface Window {\r\n  __IMMERSIVE_TRANSLATE_LOADED__?: boolean;\r\n}\r\n\r\n// 防止重复注入\r\nconst initContentScript = () => {\r\n  if (window.__IMMERSIVE_TRANSLATE_LOADED__) {\r\n    console.log('Immersive Translate content script already loaded, skipping initialization');\r\n    return false;\r\n  }\r\n  window.__IMMERSIVE_TRANSLATE_LOADED__ = true;\r\n  return true;\r\n};\r\n\r\n// 如果脚本已经加载，则直接退出函数\r\nif (!initContentScript()) {\r\n  // 退出整个脚本执行\r\n  throw new Error('Immersive Translate content script already loaded, skipping initialization');\r\n}\r\n\r\n// 类型定义\r\ninterface TranslationBubble {\r\n  show: (selection: Selection, text: string, rect: DOMRect) => void;\r\n  hide: () => void;\r\n  isVisible: () => boolean;\r\n}\r\n\r\ninterface TranslationResult {\r\n  ok: boolean;\r\n  data?: {\r\n    translatedText: string;\r\n    detectedLanguage?: string;\r\n    alternatives?: string[];\r\n  };\r\n  error?: {\r\n    code: string;\r\n    message: string;\r\n  };\r\n}\r\n\r\n// 全局状态\r\nlet shadowRoot: ShadowRoot | null = null;\r\nlet bubbleContainer: HTMLDivElement | null = null;\r\nlet isImmersiveMode = false;\r\nlet currentSelection: Selection | null = null;\r\n// 拖动相关变量\r\nlet isDragging = false;\r\nlet dragOffsetX = 0;\r\nlet dragOffsetY = 0;\r\nlet currentBubble: HTMLDivElement | null = null;\r\n// 扩展状态\r\nlet extensionInitialized = false;\r\nlet retryCount = 0;\r\nconst MAX_RETRY_COUNT = 3;\r\n\r\n// 初始化扩展\r\nasync function initializeExtension(): Promise<boolean> {\r\n  try {\r\n    if (extensionInitialized) return true;\r\n\r\n    // 检查扩展状态\r\n    const isReady = await checkExtensionStatus();\r\n    if (isReady) {\r\n      extensionInitialized = true;\r\n      retryCount = 0;\r\n      console.log('Extension initialized successfully');\r\n      return true;\r\n    } else {\r\n      throw new Error('Extension not ready');\r\n    }\r\n  } catch (error) {\r\n    console.warn('Extension initialization failed:', error);\r\n    retryCount++;\r\n\r\n    if (retryCount < MAX_RETRY_COUNT) {\r\n      // 等待一段时间后重试\r\n      await new Promise(resolve => setTimeout(resolve, 1000));\r\n      return initializeExtension();\r\n    } else {\r\n      console.error('Extension initialization failed after max retries');\r\n      // 重置状态，允许下次重试\r\n      extensionInitialized = false;\r\n      retryCount = 0;\r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\n// 重置扩展状态\r\nfunction resetExtensionState() {\r\n  extensionInitialized = false;\r\n  retryCount = 0;\r\n  console.log('Extension state reset');\r\n}\r\n\r\n// 监听页面可见性变化，在页面重新激活时重置状态\r\ndocument.addEventListener('visibilitychange', () => {\r\n  if (!document.hidden) {\r\n    resetExtensionState();\r\n  }\r\n});\r\n\r\n// 监听页面卸载，清理状态\r\nwindow.addEventListener('beforeunload', () => {\r\n  resetExtensionState();\r\n  // 清理防重复注入标记\r\n  // @ts-ignore TypeScript不识别自定义属性，但这是有效的JavaScript\r\n  delete window.__IMMERSIVE_TRANSLATE_LOADED__;\r\n});\r\n\r\n// 页面加载完成后自动初始化扩展\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n  console.log('Page loaded, initializing extension...');\r\n  try {\r\n    await initializeExtension();\r\n  } catch (error) {\r\n    console.warn('Auto-initialization failed:', error);\r\n  }\r\n});\r\n\r\n// 如果页面已经加载完成，立即初始化\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', async () => {\r\n    console.log('Page loaded, initializing extension...');\r\n    try {\r\n      await initializeExtension();\r\n    } catch (error) {\r\n      console.warn('Auto-initialization failed:', error);\r\n    }\r\n  });\r\n} else {\r\n  // 页面已经加载完成，立即初始化\r\n  console.log('Page already loaded, initializing extension...');\r\n  initializeExtension().catch(error => {\r\n    console.warn('Auto-initialization failed:', error);\r\n  });\r\n}\r\n\r\n// 创建 Shadow DOM 容器\r\nfunction createShadowContainer(): ShadowRoot {\r\n  if (shadowRoot) return shadowRoot;\r\n\r\n  const container = document.createElement('div');\r\n  container.id = 'immersive-translate-container';\r\n  container.style.cssText = `\r\n    position: fixed !important;\r\n    top: 0 !important;\r\n    left: 0 !important;\r\n    z-index: 2147483647 !important;\r\n    pointer-events: none !important;\r\n  `;\r\n\r\n  shadowRoot = container.attachShadow({ mode: 'open' });\r\n\r\n  // 加载样式\r\n  const styleLink = document.createElement('link');\r\n  styleLink.rel = 'stylesheet';\r\n  styleLink.href = chrome.runtime.getURL('contentStyle.css');\r\n  shadowRoot.appendChild(styleLink);\r\n\r\n  document.documentElement.appendChild(container);\r\n  return shadowRoot;\r\n}\r\n\r\n// 与 Service Worker 通信\r\nasync function sendMessage(type: string, payload: any): Promise<TranslationResult> {\r\n  return new Promise((resolve) => {\r\n    try {\r\n      // 检查扩展上下文是否有效\r\n      if (!chrome.runtime?.sendMessage) {\r\n        console.warn(\"Chrome runtime not available\");\r\n        resolve({\r\n          ok: false,\r\n          error: {\r\n            code: 'RUNTIME_UNAVAILABLE',\r\n            message: '运行时不可用'\r\n          }\r\n        });\r\n        return;\r\n      }\r\n\r\n      chrome.runtime.sendMessage({ type, payload }, (response) => {\r\n        if (chrome.runtime.lastError) {\r\n          console.warn(\"Error sending message to service worker:\", chrome.runtime.lastError.message);\r\n\r\n          // 检查是否是扩展上下文失效错误\r\n          if (chrome.runtime.lastError.message?.includes('Extension context invalidated')) {\r\n            resolve({\r\n              ok: false,\r\n              error: {\r\n                code: 'EXTENSION_CONTEXT_INVALIDATED',\r\n                message: '扩展上下文已失效，请刷新页面重试'\r\n              }\r\n            });\r\n          } else {\r\n            resolve({\r\n              ok: false,\r\n              error: {\r\n                code: 'RUNTIME_ERROR',\r\n                message: chrome.runtime.lastError.message || 'Runtime error'\r\n              }\r\n            });\r\n          }\r\n        } else {\r\n          resolve(response);\r\n        }\r\n      });\r\n    } catch (error: any) {\r\n      console.error(\"Failed to send message:\", error);\r\n      resolve({\r\n        ok: false,\r\n        error: {\r\n          code: 'MESSAGE_SEND_ERROR',\r\n          message: error.message || '消息发送失败'\r\n        }\r\n      });\r\n    }\r\n  });\r\n}\r\n\r\n// 检查扩展状态\r\nasync function checkExtensionStatus(): Promise<boolean> {\r\n  try {\r\n    // 检查chrome.runtime是否可用\r\n    if (!chrome.runtime || !chrome.runtime.sendMessage) {\r\n      console.warn('Chrome runtime not available');\r\n      return false;\r\n    }\r\n\r\n    // 尝试发送一个简单的ping消息\r\n    const result = await sendMessage('ping', {});\r\n    return result.ok;\r\n  } catch (error) {\r\n    console.warn('Extension status check failed:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// 翻译文本\r\nasync function translateText(text: string, source: string = 'auto', target: string = 'zh'): Promise<TranslationResult> {\r\n  try {\r\n    // 首先初始化扩展\r\n    const isInitialized = await initializeExtension();\r\n    if (!isInitialized) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: 'EXTENSION_NOT_READY',\r\n          message: '扩展未就绪，请点击重试按钮或刷新页面'\r\n        }\r\n      };\r\n    }\r\n\r\n    const payload = {\r\n      id: Date.now().toString(),\r\n      text: text.trim(),\r\n      source,\r\n      target,\r\n      format: 'text'\r\n    };\r\n\r\n    const result = await sendMessage('translate', payload);\r\n\r\n    // 如果遇到扩展上下文失效错误，尝试重新初始化\r\n    if (!result.ok && result.error?.code === 'EXTENSION_CONTEXT_INVALIDATED') {\r\n      console.log('Extension context invalidated, attempting to reinitialize...');\r\n      resetExtensionState();\r\n      const reinitResult = await initializeExtension();\r\n      if (reinitResult) {\r\n        // 重新尝试翻译\r\n        return await sendMessage('translate', payload);\r\n      }\r\n    }\r\n\r\n    return result;\r\n  } catch (error: any) {\r\n    console.error('Translation failed:', error);\r\n    return {\r\n      ok: false,\r\n      error: {\r\n        code: 'TRANSLATION_ERROR',\r\n        message: error.message || '翻译失败'\r\n      }\r\n    };\r\n  }\r\n}\r\n\r\n// 添加词汇到本地存储和后端\r\nasync function addToVocabulary(originalText: string, translatedText: string, context?: string): Promise<void> {\r\n  try {\r\n    // 创建词汇项\r\n    const vocabularyItem = {\r\n      original: originalText,\r\n      translation: translatedText,\r\n      context: context || window.location.href,\r\n      timestamp: Date.now(),\r\n      url: window.location.href,\r\n      title: document.title\r\n    };\r\n\r\n    // 保存到本地存储\r\n    const result = await chrome.storage.local.get('vocabulary');\r\n    const vocabularyList = result.vocabulary || [];\r\n    vocabularyList.push(vocabularyItem);\r\n    \r\n    // 限制词汇数量，保留最新的1000条\r\n    if (vocabularyList.length > 1000) {\r\n      vocabularyList.splice(0, vocabularyList.length - 1000);\r\n    }\r\n    \r\n    await chrome.storage.local.set({ vocabulary: vocabularyList });\r\n\r\n    // 同时发送到后端记录\r\n    await recordWords(originalText);\r\n    \r\n    console.log('Vocabulary added successfully:', vocabularyItem);\r\n  } catch (error) {\r\n    console.error('Failed to add vocabulary:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// 记录单词到后端\r\nasync function recordWords(text: string, userId: number = 1): Promise<void> {\r\n  try {\r\n    const result = await sendMessage('recordWords', { text, userId });\r\n    \r\n    if (!result.ok) {\r\n      throw new Error(result.error?.message || '记录单词失败');\r\n    }\r\n    \r\n    console.log('Words recorded successfully:', result.data);\r\n  } catch (error) {\r\n    console.error('Failed to record words:', error);\r\n    // 记录单词失败不应该影响用户体验，所以这里只打印错误\r\n  }\r\n}\r\n\r\n// 创建翻译气泡\r\nfunction createTranslationBubble(): TranslationBubble {\r\n  let bubble: HTMLDivElement | null = null;\r\n  let isVisible = false;\r\n\r\n  const show = async (selection: Selection, text: string, rect: DOMRect) => {\r\n    if (text.length < 1 || text.length > 1000) return;\r\n\r\n    const shadow = createShadowContainer();\r\n\r\n    // 移除旧气泡\r\n    if (bubble) {\r\n      bubble.remove();\r\n    }\r\n\r\n    // 创建气泡容器\r\n    bubble = document.createElement('div');\r\n    bubble.className = 'translation-bubble';\r\n    bubble.style.cssText = `\r\n      position: fixed;\r\n      left: ${rect.left + rect.width / 2}px;\r\n      top: ${rect.bottom + 8}px;\r\n      transform: translateX(-50%);\r\n      pointer-events: auto;\r\n      z-index: 10000;\r\n    `;\r\n\r\n    // 气泡内容\r\n    bubble.innerHTML = `\r\n      <div class=\"bubble-content\">\r\n        <div class=\"bubble-header\">\r\n          <div class=\"original-text\">${escapeHtml(text)}</div>\r\n          <button class=\"btn-close\" title=\"关闭翻译框\">✕</button>\r\n        </div>\r\n        <div class=\"translation-loading\">\r\n          <div class=\"loading-spinner\"></div>\r\n          <span>翻译中...</span>\r\n        </div>\r\n        <div class=\"translation-result\" style=\"display: none;\">\r\n          <div class=\"translated-text\"></div>\r\n          <div class=\"bubble-actions\">\r\n            <button class=\"btn-copy\" title=\"复制翻译\">📋</button>\r\n            <button class=\"btn-replace\" title=\"替换原文\">🔄</button>\r\n            <button class=\"btn-vocabulary\" title=\"添加到词汇本\">📚</button>\r\n            <button class=\"btn-more\" title=\"更多选项\">⚙️</button>\r\n          </div>\r\n        </div>\r\n        <div class=\"bubble-error\" style=\"display: none;\">\r\n          <span class=\"error-message\">翻译失败</span>\r\n          <button class=\"btn-retry\">重试</button>\r\n        </div>\r\n      </div>\r\n      <div class=\"bubble-arrow\"></div>\r\n    `;\r\n\r\n    shadow.appendChild(bubble);\r\n    isVisible = true;\r\n    currentBubble = bubble;\r\n\r\n    // 绑定事件\r\n    bindBubbleEvents(bubble, selection, text);\r\n    bindDragEvents(bubble);\r\n\r\n    // 开始翻译\r\n    try {\r\n      const result = await translateText(text);\r\n      updateBubbleContent(bubble, result);\r\n    } catch (error: any) {\r\n      showBubbleError(bubble, error.message || '未知错误');\r\n    }\r\n\r\n    // 点击外部关闭\r\n    setTimeout(() => {\r\n      document.addEventListener('click', handleOutsideClick, true);\r\n    }, 100);\r\n  };\r\n\r\n  const hide = () => {\r\n    if (bubble) {\r\n      bubble.remove();\r\n      bubble = null;\r\n      isVisible = false;\r\n      currentBubble = null;\r\n      document.removeEventListener('click', handleOutsideClick, true);\r\n    }\r\n  };\r\n\r\n  const handleOutsideClick = (event: MouseEvent) => {\r\n    if (bubble && event.target && !bubble.contains(event.target as Node)) {\r\n      hide();\r\n    }\r\n  };\r\n\r\n  return { show, hide, isVisible: () => isVisible };\r\n}\r\n\r\n// 绑定拖动事件\r\nfunction bindDragEvents(bubble: HTMLDivElement) {\r\n  let isDragging = false;\r\n  let offsetX = 0, offsetY = 0;\r\n\r\n  const bubbleHeader = bubble.querySelector('.bubble-header') as HTMLElement;\r\n  if (!bubbleHeader) return;\r\n\r\n  bubbleHeader.addEventListener('mousedown', (e) => {\r\n    // 只有在标题栏上按下才触发拖动\r\n    isDragging = true;\r\n    const rect = bubble.getBoundingClientRect();\r\n    offsetX = e.clientX - rect.left;\r\n    offsetY = e.clientY - rect.top;\r\n\r\n    // 防止文本选择\r\n    e.preventDefault();\r\n  });\r\n\r\n  document.addEventListener('mousemove', (e) => {\r\n    if (!isDragging) return;\r\n\r\n    const x = e.clientX - offsetX;\r\n    const y = e.clientY - offsetY;\r\n\r\n    bubble.style.left = `${x}px`;\r\n    bubble.style.top = `${y}px`;\r\n    bubble.style.transform = 'none'; // 移除原有的变换\r\n\r\n    // 隐藏箭头\r\n    const arrow = bubble.querySelector('.bubble-arrow') as HTMLElement;\r\n    if (arrow) {\r\n      arrow.style.display = 'none';\r\n    }\r\n  });\r\n\r\n  document.addEventListener('mouseup', () => {\r\n    isDragging = false;\r\n  });\r\n}\r\n\r\n// 绑定气泡事件\r\nfunction bindBubbleEvents(bubble: HTMLDivElement, selection: Selection, originalText: string) {\r\n  const closeBtn = bubble.querySelector('.btn-close') as HTMLButtonElement;\r\n  const copyBtn = bubble.querySelector('.btn-copy') as HTMLButtonElement;\r\n  const replaceBtn = bubble.querySelector('.btn-replace') as HTMLButtonElement;\r\n  const vocabularyBtn = bubble.querySelector('.btn-vocabulary') as HTMLButtonElement;\r\n  const moreBtn = bubble.querySelector('.btn-more') as HTMLButtonElement;\r\n  const retryBtn = bubble.querySelector('.btn-retry') as HTMLButtonElement;\r\n\r\n  // 关闭按钮事件\r\n  closeBtn?.addEventListener('click', () => {\r\n    translationBubble.hide();\r\n  });\r\n\r\n  copyBtn?.addEventListener('click', () => {\r\n    const translatedText = bubble.querySelector('.translated-text')?.textContent;\r\n    if (translatedText) {\r\n      navigator.clipboard.writeText(translatedText).then(() => {\r\n        showToast('已复制到剪贴板');\r\n      });\r\n    }\r\n  });\r\n\r\n  replaceBtn?.addEventListener('click', () => {\r\n    const translatedText = bubble.querySelector('.translated-text')?.textContent;\r\n    if (translatedText && selection.rangeCount > 0) {\r\n      const range = selection.getRangeAt(0);\r\n      range.deleteContents();\r\n      range.insertNode(document.createTextNode(translatedText));\r\n      selection.removeAllRanges();\r\n      translationBubble.hide();\r\n      showToast('已替换原文');\r\n    }\r\n  });\r\n\r\n  vocabularyBtn?.addEventListener('click', async () => {\r\n    const translatedText = bubble.querySelector('.translated-text')?.textContent;\r\n    if (translatedText && originalText) {\r\n      try {\r\n        await addToVocabulary(originalText, translatedText);\r\n        showToast('已添加到词汇本');\r\n      } catch (error) {\r\n        showToast('添加到词汇本失败');\r\n        console.error('Add to vocabulary failed:', error);\r\n      }\r\n    }\r\n  });\r\n\r\n  moreBtn?.addEventListener('click', () => {\r\n    openImmersiveMode(originalText);\r\n  });\r\n\r\n  retryBtn?.addEventListener('click', async () => {\r\n    // 检查bubble是否仍然存在\r\n    if (!bubble || !document.contains(bubble)) {\r\n      console.warn('Bubble no longer exists, skipping retry');\r\n      return;\r\n    }\r\n    \r\n    showBubbleLoading(bubble);\r\n    try {\r\n      const result = await translateText(originalText);\r\n      updateBubbleContent(bubble, result);\r\n    } catch (error: any) {\r\n      showBubbleError(bubble, error.message || '未知错误');\r\n    }\r\n  });\r\n}\r\n\r\n// 更新气泡内容\r\nfunction updateBubbleContent(bubble: HTMLDivElement | null, result: TranslationResult) {\r\n  // 检查bubble是否存在\r\n  if (!bubble) {\r\n    console.warn('Bubble is null, cannot update content');\r\n    return;\r\n  }\r\n\r\n  const loadingEl = bubble.querySelector('.translation-loading') as HTMLDivElement;\r\n  const resultEl = bubble.querySelector('.translation-result') as HTMLDivElement;\r\n  const errorEl = bubble.querySelector('.bubble-error') as HTMLDivElement;\r\n  const translatedTextEl = bubble.querySelector('.translated-text') as HTMLDivElement;\r\n\r\n  // 检查所有必需的元素是否存在\r\n  if (!loadingEl || !resultEl || !errorEl || !translatedTextEl) {\r\n    console.warn('Required bubble elements not found for content update');\r\n    return;\r\n  }\r\n\r\n  loadingEl.style.display = 'none';\r\n  errorEl.style.display = 'none';\r\n\r\n  if (result.ok && result.data) {\r\n    // 创建带内联样式的翻译气泡容器\r\n    const bubbleDiv = document.createElement('div');\r\n    bubbleDiv.textContent = result.data.translatedText;\r\n    Object.assign(bubbleDiv.style, {\r\n      backgroundColor: '#f9f9f9',\r\n      color: '#000',\r\n      borderRadius: '8px',\r\n      padding: '8px',\r\n      boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',\r\n      fontSize: '14px',\r\n      lineHeight: '1.6',\r\n      maxWidth: '300px',\r\n      wordWrap: 'break-word',\r\n      whiteSpace: 'pre-wrap',\r\n      zIndex: '999999',\r\n      display: 'inline-block',\r\n      pointerEvents: 'none',\r\n      backdropFilter: 'blur(1px)',\r\n      border: '1px solid rgba(0, 0, 0, 0.1)',\r\n    });\r\n\r\n    // 检测暗色模式\r\n    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\r\n      bubbleDiv.style.backgroundColor = 'rgba(30, 30, 30, 0.95)';\r\n      bubbleDiv.style.color = '#fff';\r\n      bubbleDiv.style.border = '1px solid rgba(255, 255, 255, 0.1)';\r\n    }\r\n\r\n    // 清空原来的translatedTextEl并添加新的包装元素\r\n    translatedTextEl.innerHTML = '';\r\n    translatedTextEl.appendChild(bubbleDiv);\r\n    resultEl.style.display = 'block';\r\n  } else {\r\n    showBubbleError(bubble, result.error?.message || '翻译失败');\r\n  }\r\n}\r\n\r\n// 显示气泡加载状态\r\nfunction showBubbleLoading(bubble: HTMLDivElement | null) {\r\n  // 检查bubble是否存在\r\n  if (!bubble) {\r\n    console.warn('Bubble is null, cannot show loading');\r\n    return;\r\n  }\r\n\r\n  // 检查bubble是否仍在DOM中\r\n  if (!document.contains(bubble)) {\r\n    console.warn('Bubble is no longer in DOM, cannot show loading');\r\n    return;\r\n  }\r\n\r\n  // 使用可选链操作符安全地查询元素\r\n  const loadingEl = bubble.querySelector('.translation-loading') as HTMLDivElement | null;\r\n  const resultEl = bubble.querySelector('.translation-result') as HTMLDivElement | null;\r\n  const errorEl = bubble.querySelector('.bubble-error') as HTMLDivElement | null;\r\n\r\n  // 检查所有必需的元素是否存在\r\n  if (!loadingEl || !resultEl || !errorEl) {\r\n    console.warn('Required bubble elements not found for loading');\r\n    return;\r\n  }\r\n\r\n  // 安全地设置样式\r\n  if (loadingEl) loadingEl.style.display = 'block';\r\n  if (resultEl) resultEl.style.display = 'none';\r\n  if (errorEl) errorEl.style.display = 'none';\r\n}\r\n\r\n// 显示气泡错误\r\nfunction showBubbleError(bubble: HTMLDivElement | null, message: string) {\r\n  // 检查bubble是否存在\r\n  if (!bubble) {\r\n    console.warn('Bubble is null, cannot show error:', message);\r\n    return;\r\n  }\r\n\r\n  const loadingEl = bubble.querySelector('.translation-loading') as HTMLDivElement;\r\n  const resultEl = bubble.querySelector('.translation-result') as HTMLDivElement;\r\n  const errorEl = bubble.querySelector('.bubble-error') as HTMLDivElement;\r\n  const errorMessageEl = bubble.querySelector('.error-message') as HTMLSpanElement;\r\n\r\n  // 检查所有必需的元素是否存在\r\n  if (!loadingEl || !resultEl || !errorEl || !errorMessageEl) {\r\n    console.warn('Required bubble elements not found');\r\n    return;\r\n  }\r\n\r\n  loadingEl.style.display = 'none';\r\n  resultEl.style.display = 'none';\r\n  errorMessageEl.textContent = message;\r\n  errorEl.style.display = 'block';\r\n}\r\n\r\n// 打开沉浸式模式\r\nfunction openImmersiveMode(text: string) {\r\n  if (isImmersiveMode) return;\r\n\r\n  isImmersiveMode = true;\r\n  translationBubble.hide();\r\n\r\n  // 创建沉浸式覆盖层\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'immersive-overlay';\r\n  overlay.style.cssText = `\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100vw;\r\n    height: 100vh;\r\n    background: rgba(0, 0, 0, 0.8);\r\n    z-index: 2147483646;\r\n    pointer-events: auto;\r\n  `;\r\n\r\n  overlay.innerHTML = `\r\n    <div class=\"immersive-content\">\r\n      <div class=\"immersive-header\">\r\n        <h3>沉浸式翻译</h3>\r\n        <button class=\"btn-close\">✕</button>\r\n      </div>\r\n      <div class=\"immersive-body\">\r\n        <div class=\"original-panel\">\r\n          <h4>原文</h4>\r\n          <div class=\"text-content\">${escapeHtml(text)}</div>\r\n        </div>\r\n        <div class=\"translation-panel\">\r\n          <h4>译文</h4>\r\n          <div class=\"text-content loading\">翻译中...</div>\r\n        </div>\r\n      </div>\r\n      <div class=\"immersive-footer\">\r\n        <button class=\"btn-copy-all\">复制译文</button>\r\n        <button class=\"btn-replace-all\">替换页面文本</button>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  const shadow = createShadowContainer();\r\n  shadow.appendChild(overlay);\r\n\r\n  // 绑定事件\r\n  const closeBtn = overlay.querySelector('.btn-close') as HTMLButtonElement;\r\n  const copyAllBtn = overlay.querySelector('.btn-copy-all') as HTMLButtonElement;\r\n  const replaceAllBtn = overlay.querySelector('.btn-replace-all') as HTMLButtonElement;\r\n\r\n  closeBtn.addEventListener('click', () => {\r\n    overlay.remove();\r\n    isImmersiveMode = false;\r\n  });\r\n\r\n  // 开始翻译\r\n  translateText(text).then(result => {\r\n    const translationPanel = overlay.querySelector('.translation-panel .text-content') as HTMLDivElement;\r\n    if (result.ok && result.data) {\r\n      translationPanel.textContent = result.data.translatedText;\r\n      translationPanel.classList.remove('loading');\r\n\r\n      // 绑定复制和替换事件\r\n      copyAllBtn.addEventListener('click', () => {\r\n        navigator.clipboard.writeText(result.data!.translatedText).then(() => {\r\n          showToast('已复制到剪贴板');\r\n        });\r\n      });\r\n\r\n      replaceAllBtn.addEventListener('click', () => {\r\n        if (currentSelection && currentSelection.rangeCount > 0) {\r\n          const range = currentSelection.getRangeAt(0);\r\n          range.deleteContents();\r\n          range.insertNode(document.createTextNode(result.data!.translatedText));\r\n          currentSelection.removeAllRanges();\r\n        }\r\n        overlay.remove();\r\n        isImmersiveMode = false;\r\n        showToast('已替换原文');\r\n      });\r\n    } else {\r\n      translationPanel.textContent = '翻译失败：' + (result.error?.message || '未知错误');\r\n      translationPanel.classList.remove('loading');\r\n    }\r\n  });\r\n\r\n  // ESC 键关闭\r\n  const handleEscape = (event: KeyboardEvent) => {\r\n    if (event.key === 'Escape') {\r\n      overlay.remove();\r\n      isImmersiveMode = false;\r\n      document.removeEventListener('keydown', handleEscape);\r\n    }\r\n  };\r\n  document.addEventListener('keydown', handleEscape);\r\n}\r\n\r\n// 显示提示消息\r\nfunction showToast(message: string) {\r\n  const shadow = createShadowContainer();\r\n  const toast = document.createElement('div');\r\n  toast.className = 'toast-message';\r\n  toast.textContent = message;\r\n  toast.style.cssText = `\r\n    position: fixed;\r\n    top: 20px;\r\n    right: 20px;\r\n    background: #333;\r\n    color: white;\r\n    padding: 12px 20px;\r\n    border-radius: 6px;\r\n    z-index: 10001;\r\n    pointer-events: auto;\r\n    opacity: 0;\r\n    transition: opacity 0.3s ease;\r\n  `;\r\n\r\n  shadow.appendChild(toast);\r\n\r\n  // 动画显示\r\n  requestAnimationFrame(() => {\r\n    toast.style.opacity = '1';\r\n  });\r\n\r\n  // 3秒后自动消失\r\n  setTimeout(() => {\r\n    toast.style.opacity = '0';\r\n    setTimeout(() => toast.remove(), 300);\r\n  }, 3000);\r\n}\r\n\r\n// HTML 转义\r\nfunction escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n// 获取选中文本和位置\r\nfunction getSelectionInfo(): { text: string; rect: DOMRect } | null {\r\n  const selection = window.getSelection();\r\n  if (!selection || selection.rangeCount === 0) return null;\r\n\r\n  const text = selection.toString().trim();\r\n  if (!text || text.length < 1 || text.length > 1000) return null;\r\n\r\n  const range = selection.getRangeAt(0);\r\n  const rect = range.getBoundingClientRect();\r\n\r\n  return { text, rect };\r\n}\r\n\r\n// 创建翻译气泡实例\r\nconst translationBubble = createTranslationBubble();\r\n\r\n// 事件监听器\r\ndocument.addEventListener('mouseup', () => {\r\n  // 延迟检查选择，确保选择已完成\r\n  setTimeout(() => {\r\n    const selectionInfo = getSelectionInfo();\r\n    if (selectionInfo) {\r\n      currentSelection = window.getSelection();\r\n      translationBubble.show(currentSelection!, selectionInfo.text, selectionInfo.rect);\r\n    } else if (!translationBubble.isVisible()) {\r\n      translationBubble.hide();\r\n    }\r\n  }, 100);\r\n});\r\n\r\n// 双击翻译\r\ndocument.addEventListener('dblclick', () => {\r\n  setTimeout(() => {\r\n    const selectionInfo = getSelectionInfo();\r\n    if (selectionInfo) {\r\n      currentSelection = window.getSelection();\r\n      translationBubble.show(currentSelection!, selectionInfo.text, selectionInfo.rect);\r\n    }\r\n  }, 100);\r\n});\r\n\r\n// 键盘快捷键\r\ndocument.addEventListener('keydown', (event) => {\r\n  // Esc 关闭气泡\r\n  if (event.key === 'Escape') {\r\n    translationBubble.hide();\r\n  }\r\n\r\n  // Ctrl+Shift+Y 开启沉浸式模式\r\n  if (event.ctrlKey && event.shiftKey && event.key === 'Y') {\r\n    event.preventDefault();\r\n    const selectionInfo = getSelectionInfo();\r\n    if (selectionInfo) {\r\n      currentSelection = window.getSelection();\r\n      openImmersiveMode(selectionInfo.text);\r\n    }\r\n  }\r\n});\r\n\r\n// 监听来自 Service Worker 的消息\r\nchrome.runtime.onMessage.addListener((message, _sender) => {\r\n  if (message.type === 'toggleImmersive') {\r\n    const selectionInfo = getSelectionInfo();\r\n    if (selectionInfo) {\r\n      currentSelection = window.getSelection();\r\n      openImmersiveMode(selectionInfo.text);\r\n    }\r\n  }\r\n});\r\n\r\nconsole.log('Immersive Translate Content Script loaded');"],"names":["isDragging"],"mappings":"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"}