# 解决 "Extension context invalidated" 错误

## 错误原因

"Extension context invalidated" 错误通常发生在以下情况：

1. **扩展被重新加载或更新**
2. **Service Worker被重启**
3. **扩展权限被撤销**
4. **浏览器重启后扩展状态丢失**
5. **扩展代码更新后未正确重新加载**

## 已实施的修复

### 1. 改进的错误处理
- 在 `contentScript.tsx` 中添加了专门的错误检测
- 区分不同类型的运行时错误
- 提供更友好的错误提示

### 2. 扩展状态检查
- 添加了 `checkExtensionStatus()` 函数
- 在翻译前检查扩展是否正常工作
- 使用ping/pong机制验证连接

### 3. 自动恢复机制
- 添加了 `initializeExtension()` 函数
- 支持自动重试（最多3次）
- 在扩展失效时自动重新初始化

### 4. Service Worker改进
- 添加了ping消息处理
- 改进了生命周期事件处理
- 增强了错误处理机制

## 解决步骤

### 方法1: 重新加载扩展（推荐）
1. 打开 `chrome://extensions/`
2. 找到 "Immersive Translate" 插件
3. 点击刷新按钮 🔄
4. 刷新当前网页
5. 重新尝试翻译

### 方法2: 完全重新加载
1. 打开 `chrome://extensions/`
2. 找到 "Immersive Translate" 插件
3. 点击 "移除" 按钮
4. 重新加载 `trans-frontend/dist` 目录
5. 刷新网页

### 方法3: 清理浏览器缓存
1. 按 `Cmd + Shift + Delete` (Mac)
2. 选择 "高级" 标签
3. 勾选所有选项
4. 点击 "清除数据"
5. 重启Chrome浏览器
6. 重新加载扩展

## 预防措施

### 1. 避免频繁更新
- 不要频繁重新加载扩展
- 在开发时使用Chrome的"重新加载"按钮而不是完全移除

### 2. 检查扩展状态
- 定期检查扩展是否正常工作
- 如果出现错误，及时重新加载

### 3. 使用稳定的开发环境
- 确保后端服务稳定运行
- 避免网络连接问题

## 调试信息

如果问题仍然存在，请检查：

1. **Chrome开发者工具控制台**：
   - 查看是否有其他错误信息
   - 检查Service Worker日志

2. **扩展错误页面**：
   - 访问 `chrome://extensions/`
   - 点击插件的 "错误" 按钮

3. **Service Worker调试**：
   - 在扩展管理页面点击 "检查视图"
   - 查看Service Worker控制台

## 常见问题

### Q: 为什么会出现这个错误？
A: 这通常是因为扩展的Service Worker被重启或扩展被重新加载导致的。

### Q: 如何避免这个错误？
A: 避免频繁重新加载扩展，使用稳定的开发环境。

### Q: 错误出现后如何快速恢复？
A: 使用扩展管理页面的刷新按钮，然后刷新网页。

### Q: 这个修复是否永久有效？
A: 是的，新的错误处理机制会自动检测和恢复扩展状态。
